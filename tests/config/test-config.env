#!/usr/bin/env bash
# =============================================================================
# Test Configuration
# =============================================================================
# This file contains environment-specific configuration for the Unicity CLI
# test suite. All tests source this file to obtain consistent configuration.
#
# Usage:
#   source tests/config/test-config.env
# =============================================================================

# -----------------------------------------------------------------------------
# Aggregator Configuration
# -----------------------------------------------------------------------------

# Aggregator endpoint URL
# Default: http://localhost:3000
# Override: Set UNICITY_AGGREGATOR_URL environment variable
export UNICITY_AGGREGATOR_URL="${UNICITY_AGGREGATOR_URL:-http://localhost:3000}"

# Aggregator timeout in seconds
export UNICITY_AGGREGATOR_TIMEOUT="${UNICITY_AGGREGATOR_TIMEOUT:-30}"

# Maximum number of retries for aggregator requests
export UNICITY_AGGREGATOR_MAX_RETRIES="${UNICITY_AGGREGATOR_MAX_RETRIES:-3}"

# Delay between retries (seconds)
export UNICITY_AGGREGATOR_RETRY_DELAY="${UNICITY_AGGREGATOR_RETRY_DELAY:-2}"

# -----------------------------------------------------------------------------
# Test Execution Configuration
# -----------------------------------------------------------------------------

# Enable debug mode (set to 1 for verbose output)
export UNICITY_TEST_DEBUG="${UNICITY_TEST_DEBUG:-0}"

# Enable trace mode (set to 1 for bash trace output)
export UNICITY_TEST_TRACE="${UNICITY_TEST_TRACE:-0}"

# Test timeout in seconds (per test case)
export UNICITY_TEST_TIMEOUT="${UNICITY_TEST_TIMEOUT:-60}"

# Enable parallel test execution (set to 1 to enable)
export UNICITY_TEST_PARALLEL="${UNICITY_TEST_PARALLEL:-0}"

# Number of parallel jobs (default: number of CPU cores)
export UNICITY_TEST_PARALLEL_JOBS="${UNICITY_TEST_PARALLEL_JOBS:-$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4)}"

# -----------------------------------------------------------------------------
# Test Data Configuration
# -----------------------------------------------------------------------------

# Test data directory (relative to tests/)
export UNICITY_TEST_FIXTURES_DIR="${UNICITY_TEST_FIXTURES_DIR:-fixtures}"

# Temporary directory for test artifacts
export UNICITY_TEST_TMP_DIR="${UNICITY_TEST_TMP_DIR:-tmp}"

# Keep temporary files after test run (set to 1 to keep)
export UNICITY_TEST_KEEP_TMP="${UNICITY_TEST_KEEP_TMP:-0}"

# -----------------------------------------------------------------------------
# Unique ID Generation Configuration
# -----------------------------------------------------------------------------

# ID prefix for test runs (helps identify test data in aggregator)
export UNICITY_TEST_ID_PREFIX="${UNICITY_TEST_ID_PREFIX:-test}"

# Namespace for test runs (used in ID generation)
export UNICITY_TEST_NAMESPACE="${UNICITY_TEST_NAMESPACE:-bats}"

# Enable UUID v4 generation (set to 0 to use timestamp-based IDs)
export UNICITY_TEST_USE_UUID="${UNICITY_TEST_USE_UUID:-0}"

# -----------------------------------------------------------------------------
# CLI Configuration
# -----------------------------------------------------------------------------

# Path to Unicity CLI binary
export UNICITY_CLI_BIN="${UNICITY_CLI_BIN:-dist/index.js}"

# Node.js executable path
export UNICITY_NODE_BIN="${UNICITY_NODE_BIN:-node}"

# CLI timeout in seconds
export UNICITY_CLI_TIMEOUT="${UNICITY_CLI_TIMEOUT:-30}"

# -----------------------------------------------------------------------------
# Token Test Configuration
# -----------------------------------------------------------------------------

# Default token amount for tests
export UNICITY_TEST_DEFAULT_AMOUNT="${UNICITY_TEST_DEFAULT_AMOUNT:-100}"

# Default token type identifier
export UNICITY_TEST_DEFAULT_TYPE="${UNICITY_TEST_DEFAULT_TYPE:-0x0000000000000000000000000000000000000000000000000000000000000000}"

# Token verification strictness (set to 1 for strict verification)
export UNICITY_TEST_STRICT_VERIFICATION="${UNICITY_TEST_STRICT_VERIFICATION:-1}"

# -----------------------------------------------------------------------------
# Assertion Configuration
# -----------------------------------------------------------------------------

# Enable colored output for assertions (set to 1 to enable)
export UNICITY_TEST_COLOR="${UNICITY_TEST_COLOR:-1}"

# Enable verbose assertion messages (set to 1 to enable)
export UNICITY_TEST_VERBOSE_ASSERTIONS="${UNICITY_TEST_VERBOSE_ASSERTIONS:-1}"

# Enable JSON pretty-printing for assertion output
export UNICITY_TEST_PRETTY_JSON="${UNICITY_TEST_PRETTY_JSON:-1}"

# -----------------------------------------------------------------------------
# Performance Test Configuration
# -----------------------------------------------------------------------------

# Enable performance benchmarking (set to 1 to enable)
export UNICITY_TEST_BENCHMARK="${UNICITY_TEST_BENCHMARK:-0}"

# Performance threshold in milliseconds (fail if exceeded)
export UNICITY_TEST_PERF_THRESHOLD="${UNICITY_TEST_PERF_THRESHOLD:-5000}"

# -----------------------------------------------------------------------------
# Integration Test Configuration
# -----------------------------------------------------------------------------

# Skip tests requiring external services (set to 1 to skip)
export UNICITY_TEST_SKIP_EXTERNAL="${UNICITY_TEST_SKIP_EXTERNAL:-0}"

# Wait for aggregator to be ready before running tests (set to 1 to enable)
export UNICITY_TEST_WAIT_FOR_AGGREGATOR="${UNICITY_TEST_WAIT_FOR_AGGREGATOR:-1}"

# Maximum wait time for aggregator (seconds)
export UNICITY_TEST_AGGREGATOR_WAIT_TIMEOUT="${UNICITY_TEST_AGGREGATOR_WAIT_TIMEOUT:-60}"

# -----------------------------------------------------------------------------
# Validation Functions
# -----------------------------------------------------------------------------

# Validate that required binaries exist
validate_test_environment() {
  local -a missing_binaries=()

  # Check for required binaries
  if ! command -v "${UNICITY_NODE_BIN}" >/dev/null 2>&1; then
    missing_binaries+=("${UNICITY_NODE_BIN}")
  fi

  if ! command -v bats >/dev/null 2>&1; then
    missing_binaries+=("bats")
  fi

  if [[ ${#missing_binaries[@]} -gt 0 ]]; then
    printf "ERROR: Missing required binaries: %s\n" "${missing_binaries[*]}" >&2
    return 1
  fi

  # Check that CLI binary exists
  if [[ ! -f "${UNICITY_CLI_BIN}" ]]; then
    printf "ERROR: CLI binary not found at: %s\n" "${UNICITY_CLI_BIN}" >&2
    printf "Hint: Run 'npm run build' to compile the CLI\n" >&2
    return 1
  fi

  return 0
}

# Print configuration summary (for debugging)
print_test_config() {
  cat <<EOF
=============================================================================
Unicity CLI Test Configuration
=============================================================================
Aggregator URL:           ${UNICITY_AGGREGATOR_URL}
CLI Binary:               ${UNICITY_CLI_BIN}
Test Namespace:           ${UNICITY_TEST_NAMESPACE}
Debug Mode:               ${UNICITY_TEST_DEBUG}
Parallel Execution:       ${UNICITY_TEST_PARALLEL} (${UNICITY_TEST_PARALLEL_JOBS} jobs)
Keep Temp Files:          ${UNICITY_TEST_KEEP_TMP}
=============================================================================
EOF
}

# Export configuration summary function
export -f validate_test_environment
export -f print_test_config
