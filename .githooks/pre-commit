#!/usr/bin/env bash
# =============================================================================
# Pre-commit Hook for Unicity CLI
# =============================================================================
# Runs quality checks before allowing commit:
# - Code linting
# - Quick smoke tests
# - Build verification
# - Dependency security check
#
# Installation:
#   git config core.hooksPath .githooks
#   chmod +x .githooks/pre-commit
#
# To bypass (not recommended):
#   git commit --no-verify
# =============================================================================

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd -P)"

# Track overall status
FAILED=0

# Helper functions
log_section() {
    echo -e "${BLUE}>>> $*${NC}"
}

log_success() {
    echo -e "${GREEN}✓ $*${NC}"
}

log_error() {
    echo -e "${RED}✗ $*${NC}"
}

log_warning() {
    echo -e "${YELLOW}⚠ $*${NC}"
}

# Check if we should run (can be disabled)
if [[ "${PRE_COMMIT_SKIP:-0}" == "1" ]]; then
    log_warning "Pre-commit checks skipped (PRE_COMMIT_SKIP=1)"
    exit 0
fi

# =============================================================================
# Quick Smoke Tests
# =============================================================================

run_smoke_tests() {
    log_section "Running quick smoke tests..."

    # Only run a subset of critical tests for speed
    if [[ ! -f "${PROJECT_ROOT}/dist/index.js" ]]; then
        log_error "CLI not built. Please run: npm run build"
        return 1
    fi

    # Check if bats is available
    if ! command -v bats &> /dev/null; then
        log_warning "BATS not installed, skipping smoke tests"
        log_warning "Install with: sudo apt-get install bats (Ubuntu/Debian) or brew install bats-core (macOS)"
        return 0
    fi

    # Run quick unit tests (fast)
    if [[ -d "${PROJECT_ROOT}/tests/unit" ]]; then
        echo "Running unit tests..."
        if timeout 30 bats "${PROJECT_ROOT}/tests/unit"/*.bats 2>/dev/null; then
            log_success "Unit tests passed"
        else
            log_error "Unit tests failed"
            return 1
        fi
    fi

    return 0
}

# =============================================================================
# Lint Code
# =============================================================================

check_lint() {
    log_section "Checking code style..."

    if [[ ! -f "${PROJECT_ROOT}/package.json" ]]; then
        log_warning "package.json not found, skipping lint check"
        return 0
    fi

    if ! command -v npm &> /dev/null; then
        log_warning "npm not found, skipping lint check"
        return 0
    fi

    # Check if eslint is configured
    if ! grep -q '"lint"' "${PROJECT_ROOT}/package.json" 2>/dev/null; then
        log_warning "No lint script in package.json, skipping"
        return 0
    fi

    echo "Running ESLint..."
    if (cd "${PROJECT_ROOT}" && npm run lint > /tmp/lint-output.txt 2>&1); then
        log_success "Code style checks passed"
        return 0
    else
        log_error "Code style checks failed"
        cat /tmp/lint-output.txt
        return 1
    fi
}

# =============================================================================
# Build Verification
# =============================================================================

verify_build() {
    log_section "Verifying build..."

    if [[ ! -f "${PROJECT_ROOT}/package.json" ]]; then
        log_warning "package.json not found, skipping build verification"
        return 0
    fi

    echo "Checking if build is needed..."

    # Get list of staged TypeScript/JavaScript files
    local changed_src_files=$(git diff --cached --name-only | grep -E '\.(ts|js|json)$' || true)

    if [[ -z "$changed_src_files" ]]; then
        log_success "No source files changed, skipping build"
        return 0
    fi

    # Check if dist/ is out of sync
    if [[ ! -d "${PROJECT_ROOT}/dist" ]]; then
        log_error "dist/ directory not found. Please run: npm run build"
        return 1
    fi

    # Verify TypeScript compilation
    echo "Verifying TypeScript compilation..."
    if (cd "${PROJECT_ROOT}" && npx -y typescript --noEmit > /tmp/ts-check.txt 2>&1); then
        log_success "TypeScript compilation verified"
        return 0
    else
        log_error "TypeScript compilation errors detected"
        cat /tmp/ts-check.txt
        return 1
    fi
}

# =============================================================================
# Check for accidental commits of sensitive files
# =============================================================================

check_sensitive_files() {
    log_section "Checking for sensitive files..."

    local sensitive_patterns=(
        '\.env'
        '\.env\.local'
        '\.env\.*.local'
        '\.secrets'
        'credentials\.json'
        'private\.key'
        '\.ssh'
        'node_modules'
    )

    local found_sensitive=0

    for pattern in "${sensitive_patterns[@]}"; do
        if git diff --cached --name-only | grep -E "$pattern" > /dev/null; then
            log_error "Attempting to commit sensitive file: $pattern"
            ((found_sensitive++))
        fi
    done

    if [[ $found_sensitive -gt 0 ]]; then
        log_error "Found $found_sensitive sensitive file(s) in commit"
        log_warning "Use: git reset HEAD <file> to unstage"
        return 1
    fi

    log_success "No sensitive files detected"
    return 0
}

# =============================================================================
# Check Commit Message
# =============================================================================

check_commit_message() {
    log_section "Checking commit message format..."

    # This would check the commit message file
    # In a pre-commit hook, we can't access the message yet
    # This is typically done in prepare-commit-msg or commit-msg hooks
    # For now, we just log a reminder

    log_success "Commit message check (deferred to commit-msg hook)"
    return 0
}

# =============================================================================
# Main Execution
# =============================================================================

main() {
    echo ""
    echo -e "${BLUE}╔════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║           Unicity CLI - Pre-commit Quality Checks              ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    # Run checks
    if ! check_sensitive_files; then
        ((FAILED++))
    fi

    if ! check_lint; then
        ((FAILED++))
    fi

    if ! verify_build; then
        ((FAILED++))
    fi

    if ! run_smoke_tests; then
        ((FAILED++))
    fi

    # Summary
    echo ""
    if [[ $FAILED -eq 0 ]]; then
        echo -e "${GREEN}╔════════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${GREEN}║              Pre-commit checks PASSED - Ready to commit!        ║${NC}"
        echo -e "${GREEN}╚════════════════════════════════════════════════════════════════╝${NC}"
        echo ""
        exit 0
    else
        echo -e "${RED}╔════════════════════════════════════════════════════════════════╗${NC}"
        echo -e "${RED}║          Pre-commit checks FAILED - Fix issues before commit    ║${NC}"
        echo -e "${RED}╚════════════════════════════════════════════════════════════════╝${NC}"
        echo ""
        echo "To bypass these checks (not recommended):"
        echo "  git commit --no-verify"
        echo ""
        exit 1
    fi
}

# Run main
main "$@"
